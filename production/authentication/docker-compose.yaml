name: authentication

networks:
  proxy:
    external: true

volumes:
  authelia-data:
    name: authelia-data

services:
  authelia:
    image: "authelia/authelia"
    container_name: authelia
    volumes:
      - authelia-data:/config
      - /etc/localtime:/etc/localtime:ro
    configs:
    - source: configuration.yml
      target: /config/configuration.yml
    - source: users_database.yml
      target: /config/users_database.yml
    networks:
      - proxy
    ports:
      - 9091:9091
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.entrypoints=https"
      - "traefik.http.routers.authelia.rule=Host(`auth.binarybraids.com`)"
      - "traefik.http.routers.authelia.tls=true"
      - "traefik.http.middlewares.authelia.forwardAuth.address=http://authelia:9091/api/verify?rd=https://auth.binarybraids.com/"
      - "traefik.http.middlewares.authelia.forwardAuth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Email,Remote-Name"
      - "traefik.http.middlewares.authelia-basic.forwardAuth.address=http://authelia:9091/api/verify?auth=basic"
      - "traefik.http.middlewares.authelia-basic.forwardAuth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia-basic.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"
      - "traefik.docker.network=proxy" 
    restart: "unless-stopped"

configs:
  configuration.yml:
    content: |
      theme: dark

      jwt_secret: "${AUTHELIA_JWT_SECRET}"

      password_policy:
        standard:
          enabled: false
          min_length: 12
          max_length: 0
          require_uppercase: true
          require_lowercase: true
          require_number: true
          require_symbol: true

      zxcvbn:
        enabled: false
        min_score: 3

      access_control:
        default_policy: two_factor

      session:
        name: authelia_session
        domain: binarybraids.com
        expiration: 1h
        inactivity: 5m
        remember_me_duration: 1M

      regulation:
        max_retries: 3
        find_time: 2m
        ban_time: 5m

      storage:
        encryption_key: "${AUTHELIA_ENCRYPTION_KEY}"
        local:
          path: /config/db.sqlite3

      notifier:
        disable_startup_check: false
        filesystem:
          filename: /config/notification.txt

  users_database.yml:
    content: |
      users:
        authelia_admin:
          disabled: false
          displayname: "Authelia Administrator"
          password: "${AUTHELIA_ADMIN_PASSWORD}"
          groups:
            - admin
            - dev