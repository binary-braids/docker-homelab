name: authentication

networks:
  proxy:
    external: true

volumes:
  authelia-data:
    name: authelia-data

services:
  authelia:
    image: "authelia/authelia"
    container_name: authelia
    volumes:
      - authelia-data:/config
      - /etc/localtime:/etc/localtime:ro
    configs:
    - source: configuration.yml
      target: /config/configuration.yml
    - source: users_database.yml
      target: /config/users_database.yml
    networks:
      - proxy
    ports:
      - 9091:9091
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.authelia.entrypoints=https"
      - "traefik.http.routers.authelia.rule=Host(`auth.binarybraids.com`)"
      - "traefik.http.routers.authelia.tls=true"
      - "traefik.http.middlewares.authelia.forwardAuth.address=http://authelia:9091/api/verify?rd=https://auth.binarybraids.com/"
      - "traefik.http.middlewares.authelia.forwardAuth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Email,Remote-Name"
      - "traefik.http.middlewares.authelia-basic.forwardAuth.address=http://authelia:9091/api/verify?auth=basic"
      - "traefik.http.middlewares.authelia-basic.forwardAuth.trustForwardHeader=true"
      - "traefik.http.middlewares.authelia-basic.forwardAuth.authResponseHeaders=Remote-User,Remote-Groups,Remote-Name,Remote-Email"
      - "traefik.http.services.authelia.loadbalancer.server.port=9091"
      - "traefik.docker.network=proxy" 
    restart: "unless-stopped"

configs:
  configuration.yml:
    content: |
      server:
        address: "tcp://:9091"

      theme: dark

      identity_validation:
        reset_password:
          jwt_secret: "${AUTHELIA_JWT_SECRET}"
      
      totp:
        issuer: "authelia.com"

      authentication_backend:
        ldap:
          implementation: "activedirectory"
          address: "ldap://ad.binarybraids.com:389"
          base_dn: "DC=ad,DC=binarybraids,DC=com"
          additional_users_dn: "OU=End Users,OU=BB Users"
          additional_groups_dn: "CN=Authelia Users,OU=User,OU=Security Groups"
          users_filter: "(&(|({username_attribute}={input})({mail_attribute}={input}))(objectCategory=person)(objectClass=user)(!userAccountControl:1.2.840.113556.1.4.803:=2)(!pwdLastSet=0))"
          groups_filter: "(&(member:1.2.840.113556.1.4.1941:={dn})(objectClass=group)(objectCategory=group))"
          user: "CN=Authelia,OU=Service Accounts,OU=BB Users,DC=ad,DC=binarybraids,DC=com"
          password: "${AUTHELIA_LDAP_PASSWORD}"
          attributes:
            username: "sAMAccountName"
            display_name_attribute: "displayName"
            mail: "mail"
            group_name: "cn"

      access_control:
        default_policy: deny
        rules:
          - domain:
              - "binarybraids.com"
            policy: one_factor
            subject:
              - "group:CN=Authelia Users"

      session:
        secret: "${AUTHELIA_SESSION_SECRET}"

        cookies:
        - name: authelia_session
          domain: "binarybraids.com"
          authelia_url: "https://auth.binarybraids.com"
          same_site: "lax"
          expiration: "1h"
          inactivity: "10m"
          remember_me: "1d"

      regulation:
        max_retries: 3
        find_time: 120
        ban_time: 300

      storage:
        encryption_key: "${AUTHELIA_ENCRYPTION_KEY}"
        local:
          path: /config/db.sqlite3

      notifier:
        disable_startup_check: false
        filesystem:
          filename: /config/notification.txt

  users_database.yml:
    content: |
      users:
        authelia_admin:
          disabled: false
          displayname: "Authelia Administrator"
          password: "${AUTHELIA_ADMIN_PASSWORD}"
          groups:
            - admin
            - dev