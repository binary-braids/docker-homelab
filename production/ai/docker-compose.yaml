name: ai

networks:
  proxy:
    external: true

volumes:
  ollama-data:
    name: ollama-data
  searxng-data:
    name: searxng-data
  open-webui-data:
    name: open-webui-data
  stable-diffusion-forge-webui-data:
    name: stable-diffusion-forge-webui-data

services:

  ollama:
    image: ollama/ollama:latest@sha256:722ce8caba5f8b8bd2ee654b2e29466415be3071a704e3f4db1702b83c885f76
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]
    container_name: ollama
    restart: unless-stopped
    networks:
      - proxy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ollama-data:/root/.ollama
    environment:
      - OLLAMA_KEEP_ALIVE=24h
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ollama.rule=Host(`ollama.binarybraids.com`)"
      - "traefik.http.routers.ollama.entrypoints=https"
      - "traefik.http.routers.ollama.tls=true"
      - "traefik.http.routers.ollama.service=ollama"
      - "traefik.http.services.ollama.loadbalancer.server.port=11434"
      - "traefik.docker.network=proxy"

  searxng:
    image: searxng/searxng:latest@sha256:8c3355b2a3d0d61a2e923e53be355c4704c6c88a70e2d9ee59ed98d652a09582
    container_name: searxng
    restart: unless-stopped
    networks:
      - proxy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - searxng-data:/etc/searxng
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.searxng.rule=Host(`searxng.binarybraids.com`)"
      - "traefik.http.routers.searxng.entrypoints=https"
      - "traefik.http.routers.searxng.tls=true"
      - "traefik.http.routers.searxng.service=searxng"
      - "traefik.http.services.searxng.loadbalancer.server.port=8080"
      - "traefik.docker.network=proxy"

  open-webui:
    image: ghcr.io/open-webui/open-webui:latest@sha256:4583b4336f59227614378a0db8f044d93273d8bd5e990f3845555a6ef410f768
    container_name: open-webui
    restart: unless-stopped
    networks:
      - proxy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - open-webui-data:/app/backend/data
    environment:
      - OLLAMA_BASE_URL=https://ollama.binarybraids.com
      - RAG_WEB_SEARCH_ENGINE=searxng
      - RAG_WEB_SEARCH_RESULT_COUNT=3
      - RAG_WEB_SEARCH_CONCURRENT_REQUESTS=10
      - SEARXNG_QUERY_URL=https://searxng.binarybraids.com/search?q=<query>
      - ENABLE_IMAGE_GENERATION=True
      - AUTOMATIC1111_BASE_URL=https://stable-diffusion-webui.binarybraids.com
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.open-webui.rule=Host(`chat.binarybraids.com`)"
      - "traefik.http.routers.open-webui.entrypoints=https"
      - "traefik.http.routers.open-webui.tls=true"
      - "traefik.http.routers.open-webui.service=open-webui"
      - "traefik.http.services.open-webui.loadbalancer.server.port=8080"
      - "traefik.docker.network=proxy"  

  stable-diffusion-forge-webui:
    image: ghcr.io/yummiii/sd-webui-forge-docker:cuda-12.4.1@sha256:9c1669d8c1e50fc330ec6c26d668f7d6bd5d89d9d34e2288bea7285d9472cb14
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 3G
    container_name: stable-diffusion-forge-webui
    runtime: nvidia
    restart: unless-stopped
    environment:
      - ARGS=--listen
      - UI=forge
    networks:
      - proxy
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - stable-diffusion-forge-webui-data:/app/sd-webui
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.stable-diffusion-webui.rule=Host(`stable-diffusion-webui.binarybraids.com`)"
      - "traefik.http.routers.stable-diffusion-webui.entrypoints=https"
      - "traefik.http.routers.stable-diffusion-webui.tls=true"
      - "traefik.http.routers.stable-diffusion-webui.service=stable-diffusion-webui"
      - "traefik.http.services.stable-diffusion-webui.loadbalancer.server.port=7860"
      - "traefik.docker.network=proxy"